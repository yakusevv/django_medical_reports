{% extends 'reports/base_reports.html' %}

{% block extrahead %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
{% load i18n %}
{% endblock %}

{% block content %}
<form method="POST" id="id_request_form">
    <input type="hidden" id="id_pk" name="custId" value="">
    <div class="form-group">
        <label class="col-sm-2 control-label" for="id_doctor">
            Doctor
        </label>
        <div class="col-sm-10">
            <select class="form-control" name="doctor" id="id_doctor">
            </select>
        </div>
        <label class="col-sm-2 control-label" for="id_company">
            Company
        </label>
        <div class="col-sm-10">
            <select class="form-control" name="company" id="id_company">
            </select>
        </div>
        <label class="col-sm-2 control-label" for="id_message">
            Message
        </label>
        <div class="col-sm-10">
            <textarea name="message" class="form-control"  id="id_message"></textarea>
        </div>
    </div>
    <div class="col-sm-10">
        <button class="btn btn-success" type="submit" id="id_submit_btn">Submit</button>
    </div>
</form>

<div class="scrollbar scrollbar-black bordered-black square thin">
    <div id="id_requests_list" class="overflow-auto mt-4" style="height: 300px; width: 100%;"></div>
</div>

{% endblock %}

{% block extramedia %}
<script type="text/javascript">
    let token = '{{csrf_token}}';

    function loadOptions(){
        $.ajax({
            url : "{% url 'report_requests_options_api_url' %}",
            dataType: "json",
            type: "GET",
            success : function (data) {
                data.companies.forEach(el => {
                    let option = document.createElement("option");
                    option.value = el.pk;
                    option.innerHTML = el.name;
                    $('#id_company').append(option);
                });
                data.doctors.forEach(el => {
                    let option = document.createElement("option");
                    option.value = el.pk;
                    option.innerHTML = el.initials;
                    $('#id_doctor').append(option);
                });
            },
            error : function() {
                alert("{% trans 'Error while loading select options' %}")
            }
        })};

    function reloadRequests () {
        $.ajax({
            url : "{% url 'requests:requests-list' %}",
            dataType: "json",
            type: "GET",
            success : function (data) {
                $('#id_requests_list').html("");
                data.forEach(el => {
                    let div = document.createElement("div");
                    div.className = 'card mt-1';
                    div.innerHTML = '<div class="card-header"><div class="row">' +
                                    '<div class="col-sm">' + el.doctor_initials +'</div>' +
                                    '<div class="col-sm">' + el.company_name + '</div>' +
                                    '<div class="col-sm">' + el.date_time + '</div>' +
                                    '<button type="button" class="close" name="request_delete" value="' + el.pk +'">\n' +
                                    '  <span aria-hidden="true">&times;</span>' +
                                    '<input type="hidden" value="' +
                                    el.doctor_initials + ' ' + el.company_name + ' ' + el.date_time +
                                    '" ></button></div></div>' +
                                    '<div class="card-body">' +
                                    '<div class="card-text">' + el.message.replace(/\n/g, '<br />') + '</div></div>';
                    $('#id_requests_list').append(div);
                })},
            error : function() {
                alert("{% trans 'Error while loading report requests' %}")
            }
        });
    }

    function deleteRequest(el){
            $.ajax({
                headers: { "X-CSRFToken": token },
                url: "{%  url 'requests:requests-list' %}" + el[0].value + '/',
                data: {pk: el[0].value,
                    },
                type: 'DELETE',
                contentType: 'application/json',
                success: function(result) {
                    alert("{% trans 'Report request has been deleted' %}")
                },
                error: function(){
                    alert("{% trans 'Error while deleting report request' %}")
                }
            });
    }

    loadOptions();
    reloadRequests();
    let timeout = setInterval(reloadRequests, 5000);


    $('#id_request_form').submit( function(e) {
        e.preventDefault();
        let form = $(this);
        let post_url = "{% url 'requests:requests-list' %}"
        let post_data = form.serialize();
        $.ajax({
            headers: { "X-CSRFToken": token },
            type: 'POST',
            url: post_url,
            data: post_data,
            success: function () {
                form.fadeOut(800, function () {
                    form[0].reset();
                    form.fadeIn().delay(2000);
                    reloadRequests();
                });
            },
            error : function() {
                alert("{% trans 'Error while saving report request' %}")
            }
        });
    });

    $('#id_requests_list').on('click', 'button[name="request_delete"]', function(event){
        let r = confirm("{% trans 'Do you really want to delete this request?' %}\n" + $(this)[0].childNodes[2].value);
        if (r == true) {
            deleteRequest($(this))
        };
    });

</script>
{% endblock %}
