{% extends 'reports/base_reports.html' %}

{% block extrahead %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
{% load i18n %}
{% endblock %}

{% block content %}
<div class="card mt-2">
    <form method="POST" id="id_request_form">
    <div class="form-group mt-4">
        <label class="col-sm-2 control-label" for="id_doctor">
            Doctor
        </label>
        <div class="col-sm-6">
            <select class="form-control" name="doctor" id="id_doctor">
            </select>
        </div>
        <label class="col-sm-2 control-label" for="id_company">
            Company
        </label>
        <div class="col-sm-6">
            <select class="form-control" name="company" id="id_company">
            </select>
        </div>
        <label class="col-sm-2 control-label" for="id_message">
            Message
        </label>
        <div class="col-sm-10">
            <textarea name="message" class="form-control"  id="id_message"></textarea>
        </div>
    </div>
        <div class="col-sm-10 mb-4">
            <button class="btn btn-success" type="submit" id="id_submit_btn">{% trans 'Submit' %}</button>
        </div>
    </form>
</div>

<!-- modal edit -->
<div class="modal fade" id="id_edit_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="id_data_time_edit"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" id="id_request_form_edit">
                    <input type="hidden" id="id_pk_edit" value="">
                    <div class="form-group mt-2">
                        <label class="col-sm-2 control-label" for="id_doctor_edit">
                            Doctor
                        </label>
                        <div class="col-sm-6">
                            <select class="form-control" name="doctor" id="id_doctor_edit">
                            </select>
                        </div>
                        <label class="col-sm-2 control-label" for="id_company_edit">
                            Company
                        </label>
                        <div class="col-sm-6">
                            <select class="form-control" name="company" id="id_company_edit">
                            </select>
                        </div>
                        <label class="col-sm-2 control-label" for="id_message_edit">
                            Message
                        </label>
                        <div class="col-sm-10">
                            <textarea name="message" class="form-control"  id="id_message_edit"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans 'Close' %}</button>
                <button class="btn btn-success" type="submit" id="id_submit_btn_edit">{% trans 'Submit' %}</button>
            </div>
        </div>
    </div>
</div>

<div class="scrollbar scrollbar-black bordered-black square thin">
    <div id="id_requests_list" class="overflow-auto mt-4 mb-4 card" style="height: 700px; width: 100%;"></div>
</div>

{% endblock %}

{% block extramedia %}
<script type="text/javascript">

    let token = '{{ csrf_token }}';
    let report_requests = [];
    let is_sending = false;

    function loadOptions(){
        $.ajax({
            url : "{% url 'report_requests_options_api_url' %}",
            dataType: "json",
            type: "GET",
            success : function (data) {
                data.companies.forEach(el => {
                    let option = document.createElement("option");
                    option.value = el.pk;
                    option.innerHTML = el.name;
                    $('select[name="company"]').append(option);
                });
                data.doctors.forEach(el => {
                    let option = document.createElement("option");
                    option.value = el.pk;
                    option.innerHTML = el.initials;
                    $('select[name="doctor"]').append(option);
                });
            },
            error : function(xhr, status, error) {
                alert("{% trans 'Error while loading select options' %}\n" + xhr.responseText)
            }
        })};

    function reloadRequests () {
        $.ajax({
            url : "{% url 'requests:requests-list' %}",
            dataType: "json",
            type: "GET",
            success : function (data) {
                report_requests = data;
                $("#id_requests_count").text(report_requests.length);
                if (report_requests.length > 0){
                    $("#id_requests_info").style = 'color: red;'
                }
                else {
                    $("#id_requests_info").style = 'color: green;'
                };
                $('#id_requests_list').html("");
                data.forEach(el => {
                    let div = document.createElement("div");
                    div.className = 'card mt-1 mx-auto';
                    if (el.seen){ div.style = 'width: 90%; background-color: #B1FFB7;' }
                    else { div.style = 'width: 90%;' }
                    let ref_number_pad = ('000'+ el.ref_number).slice(-3)
                    div.innerHTML = '<div class="card-header">' +
                                    '<button type="button" class="close" name="request_cancellation" ' +
                                    'data-toggle="modal" data-target="#id_cancellation_modal" value=' + el.pk +' >' +
                                    '  <span aria-hidden="true">&times;</span></button>' +
                                    '<div class="row">' +
                                    '<div class="col-sm">' + el.doctor_initials +'</div>' +
                                    '<div class="col-sm">' + el.company_name + ' ' + ref_number_pad +
                                    '</div>' +
                                    '<div class="col-sm">' + el.date_time + '</div></div>' +
                                    '</div>' +
                                    '<div class="card-body">' +
                                    '<div class="card-text">' + el.message.replace(/\n/g, '<br />') +
                                    '</div><button type="button" class="btn btn-secondary btn-sm float-right"' +
                                    'data-toggle="modal" data-target="#id_edit_modal" name="request_edit" value=' +
                                     el.pk +'>{% trans "edit" %}</button></div>' +
                                    '<div class="card-footer">{% trans "Sender: " %}' + el.sender_initials + '</div>';
                    $('#id_requests_list').append(div);
                })},
            error : function(xhr, status, error) {
                alert("{% trans 'Error while loading report requests' %}\n" + xhr.responseText)
            }
        });
    }

    function closeCase(pk){
                if (is_sending) return false;
            $.ajax({
                beforeSend: function () {
                    is_sending = true;
                },
                complete: function () {
                    is_sending = false;
                },
                headers: { "X-CSRFToken": token },
                url: "{%  url 'requests:requests-list' %}" + pk + '/',
                data: JSON.stringify({status: "cancelled_by_company"}),
                type: 'PATCH',
                contentType: 'application/json',
                success: function(result) {
                    alert("{% trans 'Case has been closed' %}");
                    reloadRequests();
                },
                error: function(xhr, status, error){
                    alert("{% trans 'Error while closing case' %}\n" + xhr.responseText)
                }
            });
    }

    function getEdit(pk){
          $('#id_pk_edit').val(pk);
          let r = report_requests.find(x => x.pk === pk)
          $('#id_doctor_edit').val(r.doctor);
          $('#id_company_edit').val(r.company);
          $('#id_message_edit').val(r.message);
          $('#id_data_time_edit').text("{% trans 'Request from ' %}" + r.date_time);
    }

    loadOptions();
    reloadRequests();

    let timeout = setInterval(reloadRequests, 10000);

    $('#id_request_form').submit( function(e) {
        e.preventDefault();
        let form = $(this);
        let post_url = "{% url 'requests:requests-list' %}"
        let post_data = form.serialize();
        if (is_sending) return false;
        $.ajax({
            beforeSend: function () {
                is_sending = true;
            },
            complete: function () {
                is_sending = false;
            },
            headers: { "X-CSRFToken": token },
            type: 'POST',
            url: post_url,
            data: post_data,
            success: function () {
                form.fadeOut(800, function () {
                    form[0].reset();
                    form.fadeIn().delay(2000);
                    reloadRequests();
                });
            },
            error : function(xhr, status, error) {
                alert("{% trans 'Error while saving report request' %}\n" + xhr.responseText)
            }
        });
    });

    $('#id_submit_btn_edit').click( function(){
        $('#id_request_form_edit').submit()
    });

    $('#id_request_form_edit').submit( function(e) {
        e.preventDefault();
        let form = $(this);
        let pk =  form[0][0].value;
        let post_url = "{% url 'requests:requests-list' %}" + pk + '/';
        let post_data = form.serialize();
        if (is_sending) return false;
        $.ajax({
            beforeSend: function () {
                is_sending = true;
            },
            complete: function () {
                is_sending = false;
            },
            headers: { "X-CSRFToken": token },
            type: 'PUT',
            url: post_url,
            data: post_data,
            success: function () {
                    $('#id_edit_modal').modal('hide');
                    reloadRequests();
            },
            function(xhr, status, error) {
                alert("{% trans 'Error while editing report request' %}\n" + xhr.responseText)
            }
        });
    });

    $('#id_requests_list').on('click', 'button[name="request_cancellation"]', function(event){
        let pk = Number($(this)[0].value);
        r = report_requests.find(x => x.pk === pk)
        let doctor = r.doctor_initials;
        let ref_number = ('000'+ r.ref_number).slice(-3)
        let company = r.company_name;
        let date_time = r.date_time;
        let a = confirm("{% trans 'Do you really want to close this case?' %}\n" +
                        company + ' ' + ref_number + ' ' + date_time + ' ' + doctor
                        );
        if (a == true) {
            closeCase(pk)
        };
    });

    $('#id_requests_list').on('click', 'button[name="request_edit"]', function(event){
        getEdit(Number($(this)[0].value))
    });

</script>
{% endblock %}
