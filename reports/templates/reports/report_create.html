{% extends 'reports/base_reports.html' %}
{% load static i18n %}

{% block title %}
  {{ block.super }} - {% trans "Create report" %}
{% endblock %}

{% block extrahead %}
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css">

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  {{ form.media }}
  <link rel="stylesheet" href="{% static 'node_modules/croppie/croppie.css' %}" />
{% endblock %}

{% block admin-panel-content %}
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}

{% if request.user.profile.report_templates %}
  <div class="form-group col-md-12 mb-2 border-top">
    <div class="form-group col-md-6 mb-0">
      <label for="report_template" class="col-form-label">
                {% trans "Use autocomplete template" %}
      </label>
      <select name="report_template" class="form-control form-control-sm" id="id_report_template" onchange="selectTemplate()">
        <option value=""></option>
        {% for template in request.user.profile.report_templates.all %}
        <option value="{{ template.name }}">{{ template.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
{% endif %}

<form action="{% url 'report_create_url' %}" method="post" autocomplete="off" enctype="multipart/form-data">
  {% csrf_token %}
    {% for field in form %}
    <div class="form-group col-md-12 mb-2 border-top">
        <div class="form-group col-md-6 mb-0">
          {{ field|as_crispy_field }}
        </div>
      </div>
    {% endfor %}
  <table class="table">
    {{ service_items.management_form }}
    {{ service_items.non_form_errors }}
    {% for form in service_items.forms %}
    {% if forloop.first %}
    <thead>
      <tr>
        {% for field in form.visible_fields %}
        <th>{{ field.label|capfirst }}</th>
        {% endfor %}
      </tr>
    </thead>
    {% endif %}
    <tr class="formset_row">
      {% for field in form.visible_fields %}
      <td>
        {% if forloop.first %}
          {% for hidden in form.hidden_fields %}
            {{ hidden }}
          {% endfor %}
        {% endif %}
        {{ field.errors.as_ul }}
        {{ field }}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
  <div class="form-group col-md-12 mb-2 border-top">
      <div class="form-group col-md-6 mb-0">
        {{ images|crispy }}
      </div>
      <div class="col">
        <div id="id_image_crop"></div>
      </div>
  </div>
  <button type="submit" name="Create" class="btn btn-primary" id="id_create">{% trans "Create report" %}</button>

</form>
  <script src="{% static 'js/formset/jquery.formset.js' %}"></script>
  <script type="text/javascript">
  $('.formset_row').formset({
    addText: '{% trans "add service item" %}',
    deleteText: '{% trans "remove" %}',
    prefix: '{{ service_items.prefix }}',
    formTemplate: null,
    addCssClass: 'add-row',
    deleteCssClass: 'delete-row',
    formCssClass: 'dynamic-form',
    extraClasses: [],
    keepFieldValues: ":input[name$='service_price'],:input[name$='quantity']",
    added: (row)=>{ row.find('select[name*="service_items"]').djangoSelect2() },
    removed: null
  });
</script>

<script src="{% static 'node_modules/croppie/croppie.js' %}"></script>

<script type="text/javascript">
		var $uploadCrop;

		function readFile(input) {
 			if (input.files && input.files[0]) {
	            var reader = new FileReader();

	            reader.onload = function (e) {
					$('#id_image_crop').addClass('ready');
	            	$uploadCrop.croppie('bind', {
	            		url: e.target.result
	            	}).then(function(){
	            		console.log('jQuery bind complete');
	            	});
	            }

	            reader.readAsDataURL(input.files[0]);
	        }
	        else {
		        swal("Sorry - you're browser doesn't support the FileReader API");
		    }
		}
		$uploadCrop = $('#id_image_crop').croppie({
      enableExif: true,
      enableOrientation: true,
      enableResize: true,
      mouseWheelZoom: 'ctrl',
      viewport: {
         width: 200,
         height: 200,
         },
      boundary: {
         width: 300,
         height: 300
     }
		});
		$('#id_image').on('change', function () { readFile(this); });
    $('#id_create').on('click', function () {
    console.log($uploadCrop.croppie('get').points);
    var cropData = $uploadCrop.croppie('get').points;
    $("#id_x").val(cropData[0]);
    $("#id_y").val(cropData[1]);
    $("#id_w").val(cropData[2]);
    $("#id_h").val(cropData[3]);

//    $("#formUpload").submit();
  });
</script>

<script type="text/javascript">
  function selectTemplate(){
    {% autoescape off %}
    var queryset = {{ json_templates }}
    {% endautoescape %}
    var e = document.getElementById("id_report_template");
    var name = e.options[e.selectedIndex].value;
    var cause = document.getElementById("id_cause_of_visit");
    var check = document.getElementById("id_checkup");
    var addit = document.getElementById("id_additional_checkup");
    var presc = document.getElementById("id_prescription");
    var item = queryset.find(item => item.name === name);

    cause.defaultValue = item.cause_of_visit_template;
    check.defaultValue = item.checkup_template;
    addit.defaultValue = item.additional_checkup_template;
    presc.defaultValue = item.prescription_template;
  }
</script>
{% endblock %}
