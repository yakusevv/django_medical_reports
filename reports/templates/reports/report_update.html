{% extends 'reports/base_reports.html' %}
{% load static i18n %}

{% block title %}
  {{ block.super }} - {{ report.ref_number }} - {% trans "Edit" %}
{% endblock %}

{% block extrahead %}
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css">

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    {{ form.media }}
{% endblock %}

{% load crispy_forms_tags %}

{% block admin-panel-content %}
{% if not report.checked %}
<a class="admin-panel-element btn btn-danger" href="{{ report.get_delete_url }}">{% trans "Delete report" %}</a>
{% endif %}
{% endblock %}

{% block content %}
<form action="{{ report.get_update_url }}" method="post" autocomplete="off" enctype="multipart/form-data">
  {% csrf_token %}
  {% for field in form %}
  <div class="form-group col-md-12 mb-2 border-top">
      <div class="form-group col-md-6 mb-0">
        {{ field|as_crispy_field }}
      </div>
    </div>
  {% endfor %}
  <table class="table">
    {{ service_items.management_form }}
    {{ service_items.non_form_errors }}
    {% for form in service_items.forms %}
    {% if forloop.first %}
    <thead>
      <tr>
        {% for field in form.visible_fields %}
        <th>{{ field.label|capfirst }}</th>
        {% endfor %}
      </tr>
    </thead>
    {% endif %}
    <tr class="formset_row">
      {% for field in form.visible_fields %}
      <td>
        {% if forloop.first %}
          {% for hidden in form.hidden_fields %}
            {{ hidden }}
          {% endfor %}
        {% endif %}
        {{ field.errors.as_ul }}
        {{ field }}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
  <div class="row mb-2 col-md-12 border-top">
    <div class="col-sm-3 mb-2">
      <b> {% trans "Images:" %} </b>
    </div>
  </div>
  <div class="row mb-2 col-md-12 border-top">
    <div class="col">
      {% for image in report.additional_images.get_queryset %}
        <p class='mb-2'><img src="{{ image.image.url }}" alt="" width='80%'></p>
      {% endfor %}
    </div>
    <div class="row mb-2 ml-2 col-md-12">
      <a href="{{ report.get_images_update_url }}" class="btn btn-secondary">{% trans "Edit images" %}</a>
    </div>
  </div>
  {% comment %}
  {% for image in report.additional_images.get_queryset %}
  <div class="row mb-2">
        <p class='mb-1'>
          <img src="{{ image.image.url }}" alt="" width='100%'>
        </p>
  </div>
  {% endfor %}
  {% endcomment %}
  <button type="submit" name="Update" class="btn btn-primary">{% trans "Update report" %}</button>

</form>
  <script src="{% static 'js/formset/jquery.formset.js' %}"></script>
  <script type="text/javascript">
  $('.formset_row').formset({
    addText: '{% trans "add service item" %}',
    deleteText: '{% trans "remove" %}',
    prefix: '{{ service_items.prefix }}',
    formTemplate: null,
    addCssClass: 'add-row',
    deleteCssClass: 'delete-row',
    formCssClass: 'dynamic-form',
    extraClasses: [],
    keepFieldValues: ":input[name$='service_price'],:input[name$='quantity']",
    added: (row)=>{ row.find('.django-select2').djangoSelect2() },
    removed: null
  });
</script>
{% endblock %}
